name: Factory CI

on:
  push:
    branches: [ master ]
  pull_request: {}

jobs:
  lint-and-eval:
    name: Lint + Flake Eval
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        continue-on-error: true
      - name: Fast lint and evaluation
        run: bash bin/test.sh --lint

  unit:
    name: Unit (Bats)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint-and-eval
    steps:
      - uses: actions/checkout@v4
      - name: Install bats
        run: sudo apt-get update && sudo apt-get install -y bats
      - name: Run unit tests
        run: bash bin/test.sh unit

  behavioral-single-vm:
    name: Behavioral (Single VM)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: lint-and-eval
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        continue-on-error: true
      - name: Run one behavioral VM test
        run: nix build --show-trace .#checks.x86_64-linux.integration.behavioral-single-vm
