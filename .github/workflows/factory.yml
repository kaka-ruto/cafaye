name: "The Factory"

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master ]

jobs:
  # Phase 1: Fast syntax and evaluation checks (no VMs)
  check:
    name: Syntax Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v2
        continue-on-error: true
        with:
          use-nix-store-trust: true
          
      - name: Cachix Cache
        uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true

      - name: Fast Evaluation Check
        run: |
          # Only evaluate, don't run VM tests
          nix flake check --show-trace --option max-jobs 8

  # Phase 2: Parallel VM Test Groups
  test-core:
    name: Core Tests
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: DeterminateSystems/magic-nix-cache-action@v2
        continue-on-error: true
        with:
          use-nix-store-trust: true
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Run Core Unified Test
        run: nix build --show-trace .#checks.x86_64-linux.core-unified

  test-cli:
    name: CLI Tests
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: DeterminateSystems/magic-nix-cache-action@v2
        continue-on-error: true
        with:
          use-nix-store-trust: true
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Run CLI Unified Test
        run: nix build --show-trace .#checks.x86_64-linux.cli-unified

  test-modules:
    name: Modules Tests
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: DeterminateSystems/magic-nix-cache-action@v2
        continue-on-error: true
        with:
          use-nix-store-trust: true
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Run Modules Unified Test
        run: nix build --show-trace .#checks.x86_64-linux.modules-unified

  # Phase 3: Integration Tests (parallel)
  test-integration:
    name: Integration Tests
    needs: [test-core, test-cli, test-modules]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        test: [first-run-wizard, rails]
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v9
      - uses: DeterminateSystems/magic-nix-cache-action@v2
        continue-on-error: true
        with:
          use-nix-store-trust: true
      - uses: cachix/cachix-action@v14
        with:
          name: cafaye
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Run Integration Test - ${{ matrix.test }}
        run: nix build --show-trace .#checks.x86_64-linux.integration-${{ matrix.test }}

  # Phase 4: Summary (only runs if all tests pass)
  summary:
    name: Test Summary
    needs: [test-core, test-cli, test-modules, test-integration]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check All Tests Passed
        run: |
          if [ "${{ needs.test-core.result }}" == "success" ] && \
             [ "${{ needs.test-cli.result }}" == "success" ] && \
             [ "${{ needs.test-modules.result }}" == "success" ] && \
             [ "${{ needs.test-integration.result }}" == "success" ]; then
            echo "✅ All tests passed!"
            exit 0
          else
            echo "❌ Some tests failed"
            exit 1
          fi
