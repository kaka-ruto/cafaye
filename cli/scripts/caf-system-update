#!/bin/bash

# Cafaye OS System Update
# Update flake inputs and rebuild

CONFIRM=true
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -y|--yes) CONFIRM=false ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

echo "ðŸ”„ Cafaye OS System Update"
echo "=========================="
echo ""

CAFAYE_PATH="${CAFAYE_PATH:-/etc/cafaye}"

# Check if we're in the cafaye directory
if [ ! -f "$CAFAYE_PATH/flake.nix" ]; then
  echo "âŒ Cafaye flake not found at $CAFAYE_PATH"
  exit 1
fi

cd "$CAFAYE_PATH" || exit 1

echo "ðŸ“¥ Updating flake inputs..."
sudo nix flake update

echo ""
echo "ðŸ”¨ Rebuilding system..."
echo ""

# Show what will change
echo "Changes to be applied:"
sudo nixos-rebuild dry-run --flake .#cafaye 2>&1 | head -20

echo ""
if [ "$CONFIRM" = true ]; then
  if command -v gum &> /dev/null; then
    gum confirm "Apply these changes?" || {
      echo "Aborted."
      exit 0
    }
  else
    read -p "Apply these changes? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
       echo "Aborted."
       exit 0
    fi
  fi
fi

sudo nixos-rebuild switch --flake .#cafaye

if [ $? -eq 0 ]; then
  echo ""
  echo "âœ… Update complete!"
  echo ""
  echo "ðŸ’¡ Note: If something goes wrong, you can rollback with:"
  echo "   sudo nixos-rebuild switch --rollback"
  
  # Run post-update hook if it exists
  if [ -x "$HOME/.config/cafaye/hooks/post-update" ]; then
    echo ""
    echo "ðŸª Running post-update hook..."
    "$HOME/.config/cafaye/hooks/post-update"
  fi
else
  echo ""
  echo "âŒ Update failed. Check the output above for errors."
  exit 1
fi

if command -v caf-task-done &> /dev/null; then
  caf-task-done "System Update"
fi
