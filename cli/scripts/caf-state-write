#!/bin/bash

# Writes a value to environment.json or settings.json
# Usage: caf-state-write "languages.ruby" "true"

key="$1"
value="$2"
prefix=$(echo "$key" | cut -d'.' -f1)

if [[ "$prefix" == "core" || "$prefix" == "git" || "$prefix" == "backup" ]]; then
    STATE_FILE="$HOME/.config/cafaye/settings.json"
else
    STATE_FILE="$HOME/.config/cafaye/environment.json"
fi

if [[ ! -f "$STATE_FILE" ]]; then
    # Local development fallback
    REPO_DIR="$(git rev-parse --show-toplevel 2>/dev/null)"
    if [[ -n "$REPO_DIR" && -f "$REPO_DIR/$(basename "$STATE_FILE")" ]]; then
        STATE_FILE="$REPO_DIR/$(basename "$STATE_FILE")"
    else
        mkdir -p "$(dirname "$STATE_FILE")"
        echo "{}" > "$STATE_FILE"
    fi
fi

# Simple type detection for boolean/numbers
tmp=$(mktemp)
if [[ "$value" == "true" || "$value" == "false" || "$value" =~ ^[0-9]+$ ]]; then
    jq ".$key = $value" "$STATE_FILE" > "$tmp"
else
    # Treat as string
    jq ".$key = \"$value\"" "$STATE_FILE" > "$tmp"
fi

# Update state
mv "$tmp" "$STATE_FILE"

# Auto-commit if in git repo
CAFAYE_DIR=$(dirname "$STATE_FILE")
if [[ -d "$CAFAYE_DIR/.git" ]]; then
    cd "$CAFAYE_DIR"
    git add "$(basename "$STATE_FILE")"
    git commit -m "Change $key to $value" || true
fi
