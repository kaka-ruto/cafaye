#!/bin/bash

# Writes a value to user/user-state.json
# Usage: caf-state-write "languages.ruby" "true"

STATE_FILE="/etc/cafaye/user/user-state.json"

# In dev/test environments, fallback to local path if /etc doesn't exist
if [[ ! -f "$STATE_FILE" ]]; then
    STATE_FILE="$(git rev-parse --show-toplevel 2>/dev/null)/user/user-state.json"
fi

key="$1"
value="$2"

# Simple type detection for boolean/numbers
if [[ "$value" == "true" || "$value" == "false" || "$value" =~ ^[0-9]+$ ]]; then
    tmp=$(mktemp)
    jq ".$key = $value" "$STATE_FILE" > "$tmp" && mv "$tmp" "$STATE_FILE"
else
    # Treat as string
    tmp=$(mktemp)
    jq ".$key = \"$value\"" "$STATE_FILE" > "$tmp" && mv "$tmp" "$STATE_FILE"
fi
