#!/bin/bash

# Writes a value to environment.json
# Usage: caf-state-write "languages.ruby" "true"

if [[ -z "$STATE_FILE" ]]; then
    STATE_FILE="$HOME/.config/cafaye/environment.json"

    if [[ ! -f "$STATE_FILE" ]]; then
        STATE_FILE="$(git rev-parse --show-toplevel 2>/dev/null)/environment.json"
    fi
fi

key="$1"
value="$2"

# Ensure file exists
if [[ ! -f "$STATE_FILE" ]]; then
    echo "{}" > "$STATE_FILE"
fi

# Simple type detection for boolean/numbers
tmp=$(mktemp)
if [[ "$value" == "true" || "$value" == "false" || "$value" =~ ^[0-9]+$ ]]; then
    jq ".$key = $value" "$STATE_FILE" > "$tmp"
else
    # Treat as string
    jq ".$key = \"$value\"" "$STATE_FILE" > "$tmp"
fi

# Update state
mv "$tmp" "$STATE_FILE"

# Auto-commit if in git repo
CAFAYE_DIR=$(dirname "$STATE_FILE")
if [[ -d "$CAFAYE_DIR/.git" ]]; then
    cd "$CAFAYE_DIR"
    git add environment.json
    git commit -m "Change $key to $value" || true
fi
