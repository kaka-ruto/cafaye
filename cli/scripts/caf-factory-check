#!/bin/bash

# Cafaye Factory CI/CD Status Checker
# Polls GitHub Actions for builds and displays them
# Usage: caf-factory-check [--watch] [--since-hours N] [--commit SHA] [--latest]

set -e

SCRIPT_DIR="$(dirname "$(realpath "$0")")"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
FACTORY_DIR="$REPO_ROOT/.factory"
FACTORY_LOG="$FACTORY_DIR/failures.json"
FACTORY_ALL_LOG="$FACTORY_DIR/all-runs.json"

# Parse arguments
WATCH_MODE=false
SINCE_HOURS=24
COMMIT_FILTER=""
SHOW_LATEST=false
SHOW_IN_PROGRESS=false
SHOW_FAILED_STEPS=false
RUN_ID=""

usage() {
    echo "Usage: caf-factory-check [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --watch              Watch mode - refreshes every 60 seconds"
    echo "  --since-hours N      Look back N hours (default: 24)"
    echo "  --commit SHA         Filter by specific commit SHA"
    echo "  --latest             Show only the latest run"
    echo "  --in-progress        Include currently running builds"
    echo "  --failed-steps       Show failed steps for the latest failed run"
    echo "  --run-id ID          Show failed steps for specific run ID"
    echo "  -h, --help           Show this help"
    echo ""
    echo "Examples:"
    echo "  caf-factory-check                       # Check last 24h for failures"
    echo "  caf-factory-check --watch               # Watch for failures"
    echo "  caf-factory-check --commit abc123       # Check specific commit"
    echo "  caf-factory-check --latest              # Show latest run only"
    echo "  caf-factory-check --in-progress         # Include running builds"
    echo "  caf-factory-check --failed-steps        # Show failed steps only"
    echo "  caf-factory-check --run-id 12345        # Show failed steps for run"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --watch)
            WATCH_MODE=true
            shift
            ;;
        --since-hours)
            SINCE_HOURS="$2"
            shift 2
            ;;
        --commit)
            COMMIT_FILTER="$2"
            shift 2
            ;;
        --latest)
            SHOW_LATEST=true
            shift
            ;;
        --in-progress)
            SHOW_IN_PROGRESS=true
            shift
            ;;
        --failed-steps)
            SHOW_FAILED_STEPS=true
            shift
            ;;
        --run-id)
            RUN_ID="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Ensure factory directory exists
mkdir -p "$FACTORY_DIR"

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
    echo "âŒ GitHub CLI (gh) not found"
    echo "   Install it: https://cli.github.com/"
    exit 1
fi

# Check if we're in a repo with gh auth
if ! gh auth status &> /dev/null; then
    echo "âŒ Not authenticated with GitHub"
    echo "   Run: gh auth login"
    exit 1
fi

get_current_commit() {
    git rev-parse HEAD 2>/dev/null || echo ""
}

fetch_runs() {
    local limit=${1:-50}
    gh run list \
        -b master \
        -L "$limit" \
        --json databaseId,status,conclusion,headBranch,headSha,createdAt,url,event,displayTitle
}

fetch_failures() {
    local since_date
    since_date=$(date -u -v-${SINCE_HOURS}H +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -d "${SINCE_HOURS} hours ago" +"%Y-%m-%dT%H:%M:%SZ")
    
    local jq_filter="[.[] | select(.status==\"completed\" and (.conclusion==\"failure\" or .conclusion==\"startup_failure\" or .conclusion==\"timed_out\")) | select(.createdAt >= \"$since_date\")]"
    
    # If commit filter provided, add it
    if [[ -n "$COMMIT_FILTER" ]]; then
        jq_filter="[.[] | select(.headSha | startswith(\"$COMMIT_FILTER\")) | select(.status==\"completed\" and (.conclusion==\"failure\" or .conclusion==\"startup_failure\" or .conclusion==\"timed_out\"))]"
    fi
    
    gh run list \
        -b master \
        -L 50 \
        --json databaseId,status,conclusion,headBranch,headSha,createdAt,url,event,displayTitle \
        -q "$jq_filter"
}

fetch_all_runs() {
    local limit=${1:-20}
    local jq_filter="."
    
    # If commit filter provided
    if [[ -n "$COMMIT_FILTER" ]]; then
        jq_filter="[.[] | select(.headSha | startswith(\"$COMMIT_FILTER\"))]"
    fi
    
    # If showing latest only
    if [[ "$SHOW_LATEST" == true ]]; then
        jq_filter="$jq_filter | .[0:1]"
    fi
    
    gh run list \
        -b master \
        -L "$limit" \
        --json databaseId,status,conclusion,headBranch,headSha,createdAt,url,event,displayTitle \
        -q "$jq_filter"
}

get_status_icon() {
    local status="$1"
    local conclusion="$2"
    
    if [[ "$status" == "completed" ]]; then
        case "$conclusion" in
            "success") echo "âœ…" ;;
            "failure") echo "âŒ" ;;
            "cancelled") echo "ğŸš«" ;;
            "skipped") echo "â­ï¸" ;;
            *) echo "â“" ;;
        esac
    else
        echo "ğŸ”„"
    fi
}

fetch_failed_steps() {
    local run_id="$1"
    
    # Get all jobs for the run and filter for failed ones
    gh run view "$run_id" \
        --json jobs \
        -q '.jobs | map(select(.conclusion == "failure" or .conclusion == "startup_failure" or .conclusion == "timed_out")) | map({name: .name, conclusion: .conclusion, startedAt: .startedAt, completedAt: .completedAt, logsUrl: .logsUrl})'
}

show_failed_steps() {
    local run_id="$1"
    local compact="${2:-false}"
    
    if [[ -z "$run_id" ]]; then
        # Get the latest failed run
        local latest_failed
        latest_failed=$(gh run list -b master -L 1 --json databaseId,conclusion,displayTitle -q '[.[] | select(.conclusion=="failure")] | .[0]')
        
        if [[ -z "$latest_failed" ]] || [[ "$latest_failed" == "null" ]]; then
            if [[ "$compact" != "true" ]]; then
                echo "âœ… No failed runs found on master"
            fi
            return 0
        fi
        
        run_id=$(echo "$latest_failed" | jq -r '.databaseId')
        local run_title
        run_title=$(echo "$latest_failed" | jq -r '.displayTitle')
        
        if [[ "$compact" != "true" ]]; then
            echo ""
            echo "ğŸ­ FAILED STEPS FOR LATEST RUN"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Run: $run_title"
            echo "Run ID: $run_id"
            echo ""
        fi
    else
        if [[ "$compact" != "true" ]]; then
            echo ""
            echo "ğŸ­ FAILED STEPS FOR RUN ID: $run_id"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        fi
    fi
    
    # Fetch and display failed steps
    local failed_jobs
    failed_jobs=$(fetch_failed_steps "$run_id")
    
    if [[ "$failed_jobs" == "[]" ]] || [[ -z "$failed_jobs" ]]; then
        if [[ "$compact" != "true" ]]; then
            echo "âš ï¸  No failed steps found for this run"
        fi
        return 0
    fi
    
    local count
    count=$(echo "$failed_jobs" | jq 'length')
    
    if [[ "$compact" == "true" ]]; then
        echo "Run $run_id - $count failed job(s):"
    else
        echo "Found $count failed job(s):"
    fi
    echo ""
    
    echo "$failed_jobs" | jq -r '.[] | "
âŒ \(.name)
   Status: \(.conclusion)
   Started: \(.startedAt)
   Completed: \(.completedAt)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"'
    
    if [[ "$compact" != "true" ]]; then
        echo ""
        echo "To view full logs for a specific job:"
        echo "   gh run view $run_id --log-failed"
        echo ""
    fi
}

save_and_display() {
    local runs
    
    # Fetch appropriate data based on mode
    if [[ "$SHOW_IN_PROGRESS" == true ]] || [[ -n "$COMMIT_FILTER" ]] || [[ "$SHOW_LATEST" == true ]]; then
        runs=$(fetch_all_runs)
        echo "$runs" > "$FACTORY_ALL_LOG"
    else
        local failures
        failures=$(fetch_failures)
        echo "$failures" > "$FACTORY_LOG"
        
        if [[ "$failures" == "[]" ]] || [[ -z "$failures" ]]; then
            echo "âœ… No failed builds on master in the last ${SINCE_HOURS}h"
            return 0
        fi
        runs="$failures"
    fi
    
    if [[ "$runs" == "[]" ]] || [[ -z "$runs" ]]; then
        echo "â„¹ï¸  No runs found matching criteria"
        return 0
    fi
    
    local count
    count=$(echo "$runs" | jq 'length')
    
    echo ""
    if [[ "$SHOW_LATEST" == true ]]; then
        echo "ğŸ­ LATEST FACTORY RUN"
    elif [[ -n "$COMMIT_FILTER" ]]; then
        echo "ğŸ­ FACTORY RUNS FOR COMMIT: ${COMMIT_FILTER}"
    elif [[ "$SHOW_IN_PROGRESS" == true ]]; then
        echo "ğŸ­ FACTORY RUNS (including in-progress)"
    else
        echo "ğŸ­ FACTORY FAILURES (last ${SINCE_HOURS}h)"
    fi
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Found $count run(s)"
    echo ""
    
    # Display each run with proper status icons
    echo "$runs" | jq -r '.[] | 
        (if .status == "completed" then
            (if .conclusion == "success" then "âœ…"
             elif .conclusion == "failure" then "âŒ"
             elif .conclusion == "cancelled" then "ğŸš«"
             elif .conclusion == "skipped" then "â­ï¸"
             else "â“" end)
         else "ğŸ”„" end) as $icon |
        "
\($icon) \(.displayTitle)
   Run ID: \(.databaseId)
   Commit: \(.headSha[:8])
   Status: \(.status)\(if .conclusion then " (\(.conclusion))" else "" end)
   When:   \(.createdAt)
   URL:    \(.url)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"'
    
    echo ""
    if [[ "$SHOW_IN_PROGRESS" == true ]] || [[ -n "$COMMIT_FILTER" ]] || [[ "$SHOW_LATEST" == true ]]; then
        echo "ğŸ’¾ Full details saved to: $FACTORY_ALL_LOG"
    else
        echo "ğŸ’¾ Full details saved to: $FACTORY_LOG"
    fi
    echo ""
    
    # Automatically show failed steps for failed runs
    if [[ "$SHOW_IN_PROGRESS" != true ]] && [[ -z "$COMMIT_FILTER" ]] && [[ "$SHOW_LATEST" != true ]]; then
        echo "ğŸ“‹ FAILED STEPS DETAILS:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Show failed steps for each failed run (compact mode)
        while IFS= read -r run_id; do
            if [[ -n "$run_id" ]]; then
                show_failed_steps "$run_id" "true" 2>/dev/null || echo "   (Could not fetch steps for run $run_id)"
            fi
        done < <(echo "$runs" | jq -r '.[].databaseId')
    fi
    
    echo "To view full logs for a specific run:"
    echo "   gh run view <run-id> --log-failed"
    echo ""
    echo "To filter by current commit:"
    current_commit=$(get_current_commit)
    if [[ -n "$current_commit" ]]; then
        echo "   caf-factory-check --commit ${current_commit:0:7}"
    else
        echo "   caf-factory-check --commit <sha>"
    fi
}

show_last_check() {
    if [[ -f "$FACTORY_LOG" ]]; then
        local failures
        failures=$(cat "$FACTORY_LOG")
        
        if [[ "$failures" != "[]" ]] && [[ -n "$failures" ]]; then
            local count
            count=$(echo "$failures" | jq 'length')
            echo ""
            echo "ğŸ“Š LAST CHECK (saved results)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "$count failed run(s) on record"
            echo ""
            echo "$failures" | jq -r '.[] | "\(.displayTitle) - \(.conclusion)"'
            echo ""
            echo "Run 'caf-factory-check' to refresh"
        fi
    fi
}

# Main execution
if [[ "$SHOW_FAILED_STEPS" == true ]] || [[ -n "$RUN_ID" ]]; then
    if [[ -n "$RUN_ID" ]]; then
        show_failed_steps "$RUN_ID"
    else
        show_failed_steps ""
    fi
elif [[ "$WATCH_MODE" == true ]]; then
    echo "ğŸ‘ï¸  Watching for failures (Ctrl+C to stop)..."
    while true; do
        clear
        date
        echo ""
        save_and_display
        echo ""
        echo "â±ï¸  Next check in 60 seconds..."
        sleep 60
    done
else
    save_and_display
fi
