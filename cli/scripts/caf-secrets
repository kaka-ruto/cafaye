#!/bin/bash

# Cafaye OS Secrets Manager
# Usage: caf-secrets

SECRETS_FILE="/etc/cafaye/secrets/secrets.yaml"
# Fallback for dev
if [[ ! -f "$SECRETS_FILE" ]]; then
    SECRETS_FILE="$(git rev-parse --show-toplevel 2>/dev/null)/secrets/secrets.yaml"
fi

show_secrets_menu() {
    choice=$(gum choose --cursor "ðŸ‘‰ " --header "Secrets Management" \
        "ðŸ‘ï¸  View Secret Keys" \
        "âž• Add/Update Secret" \
        "ðŸ“ Edit Secrets File (sops)" \
        "â¬…ï¸  Back")

    case "$choice" in
        *"View"*) view_secret_keys ;;
        *"Add"*) add_secret ;;
        *"Edit"*) edit_secrets_file ;;
        "â¬…ï¸  Back") return 0 ;;
    esac
    show_secrets_menu
}

view_secret_keys() {
    if [[ ! -f "$SECRETS_FILE" ]]; then
        echo "âŒ Secrets file not found at $SECRETS_FILE"
        sleep 2
        return
    fi
    
    echo "ðŸ” Available secret keys:"
    sops -d "$SECRETS_FILE" 2>/dev/null | yq e 'keys' - | gum format
    read -p "Press enter to return..."
}

add_secret() {
    key=$(gum input --placeholder "Secret Key (e.g. openai_api_key)")
    [[ -z "$key" ]] && return
    
    value=$(gum input --password --placeholder "Secret Value")
    [[ -z "$value" ]] && return
    
    if [[ ! -f "$SECRETS_FILE" ]]; then
        echo "Initializing new secrets file..."
        # Initial minimal yaml if it doesn't exist
        echo "{}" > "$SECRETS_FILE"
        sops -e -i "$SECRETS_FILE"
    fi

    # Use sops to set the value
    sops --set "[\"$key\"] \"$value\"" "$SECRETS_FILE"
    echo "âœ… Secret '$key' updated!"
    sleep 1
}

edit_secrets_file() {
    sops "$SECRETS_FILE"
}

# Run
show_secrets_menu
