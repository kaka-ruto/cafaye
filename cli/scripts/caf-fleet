#!/bin/bash
set -euo pipefail

# Cafaye Fleet Management
# Usage: caf-fleet [status|add|apply]

CAFAYE_DIR=$(git rev-parse --show-toplevel 2>/dev/null || echo "$HOME/.config/cafaye")
cd "$CAFAYE_DIR" || exit 1

command="$1"

# Identify the SSH key for SOPS
SSH_PRIVATE_KEY=""
[[ -f "$HOME/.ssh/id_ed25519" ]] && SSH_PRIVATE_KEY="$HOME/.ssh/id_ed25519"
[[ -z "$SSH_PRIVATE_KEY" && -f "$HOME/.ssh/id_rsa" ]] && SSH_PRIVATE_KEY="$HOME/.ssh/id_rsa"

# Ensure SOPS_AGE_KEY is set
if [[ -n "$SSH_PRIVATE_KEY" && -z "${SOPS_AGE_KEY:-}" ]]; then
    if command -v ssh-to-age &> /dev/null; then
        export SOPS_AGE_KEY=$(ssh-to-age -private-key -i "$SSH_PRIVATE_KEY" 2>/dev/null)
    fi
fi

# Fallback if still empty
if [[ -n "$SSH_PRIVATE_KEY" && -z "${SOPS_AGE_KEY:-}" ]]; then
    export SOPS_AGE_KEY="$(nix --extra-experimental-features "nix-command flakes" shell nixpkgs#ssh-to-age --command ssh-to-age -private-key -i "$SSH_PRIVATE_KEY" 2>/dev/null || true)"
fi

run_sops() {
    nix --extra-experimental-features "nix-command flakes" shell nixpkgs#sops --command sops "$@"
}

show_fleet_status() {
    echo "ğŸ“‹ Cafaye Fleet Dashboard"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    [[ ! -f "secrets/fleet.yaml" ]] && { echo "Registry empty."; return; }

    echo "Nodes:"
    # Use JSON output for jq
    DATA=$(run_sops -d --output-type json secrets/fleet.yaml 2>/dev/null)
    if [[ -z "$DATA" ]]; then
         echo "âŒ Unable to decrypt/parse fleet registry."
    else
         echo "$DATA" | jq -r '.fleet | to_entries[] | "  - \(.key): \(.value.tailscale_ip) (\(.value.role))"'
         echo ""
         echo "Connectivity:"
         echo "$DATA" | jq -r '.fleet | to_entries[] | @base64' | while read -r row; do
             entry="$(echo "$row" | base64 --decode)"
             name="$(echo "$entry" | jq -r '.key')"
             ip="$(echo "$entry" | jq -r '.value.tailscale_ip')"
             if timeout 2 bash -lc "ping -c 1 -W 1 \"$ip\" >/dev/null 2>&1"; then
                 echo "  - ${name}: reachable"
                 proj="$(ssh -o ConnectTimeout=2 "$ip" 'jq -r ".current // \"none\"" ~/.config/cafaye/projects.json 2>/dev/null || echo n/a' 2>/dev/null || echo n/a)"
                 echo "    project: ${proj}"
             else
                 echo "  - ${name}: unreachable"
             fi
         done
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

add_fleet_node() {
    name="${2:-}"; key="${3:-}"; ip="${4:-}"; role="${5:-remote}"
    if [[ -z "$name" || -z "$key" || -z "$ip" ]]; then
        echo "Usage: caf fleet add <name> <age-key> <tailscale-ip> [role]"
        exit 1
    fi
    if [[ ! "$key" =~ ^age1[0-9a-z]+$ ]]; then
        echo "âŒ Invalid age recipient key: '$key'"
        echo "Expected format: age1..."
        exit 1
    fi
    echo "ğŸ’¾ Adding node '$name' to fleet..."
    
    if [[ -f ".sops.yaml" ]] && ! grep -q "$key" .sops.yaml; then
        echo "ğŸ”‘ Authorizing node key in .sops.yaml..."
        [[ "$(uname -s)" == "Darwin" ]] && sed -i "" "/- \"age1/a\\
          - \"$key\"" .sops.yaml || sed -i "/- \"age1/a \          - \"$key\"" .sops.yaml
    fi

    mkdir -p secrets
    tmp_plain="$(mktemp)"
    tmp_new="$(mktemp)"
    trap 'rm -f "$tmp_plain" "$tmp_new"' EXIT

    if [[ -s "secrets/fleet.yaml" ]] && run_sops -d --output-type json secrets/fleet.yaml >"$tmp_plain" 2>/dev/null; then
      :
    else
      echo "âš ï¸  Existing fleet registry is invalid or undecryptable. Reinitializing..."
      cp secrets/fleet.yaml "secrets/fleet.yaml.broken.$(date +%s)" 2>/dev/null || true
      echo '{"fleet":{}}' >"$tmp_plain"
    fi

    jq ".fleet[\"$name\"] = {\"tailscale_ip\":\"$ip\",\"role\":\"$role\",\"hostname\":\"$name\"}" "$tmp_plain" >"$tmp_new"

    echo "ğŸ”„ Updating encrypted registry..."
    run_sops -e --input-type json --output-type yaml --filename-override secrets/fleet.yaml "$tmp_new" > secrets/fleet.yaml

    echo "âœ… Node '$name' added."
}

fleet_apply() {
    echo "ğŸš€ Orchestrating fleet-wide apply..."
    remotes=$(run_sops -d --output-type json secrets/fleet.yaml 2>/dev/null | jq -r '.fleet | to_entries[] | select(.value.role == "remote") | .value.tailscale_ip')
    [[ -z "$remotes" ]] && { echo "No remote nodes found."; return; }

    SSH_OPT=""
    [[ -f "$HOME/.ssh/cafaye" ]] && SSH_OPT="-i $HOME/.ssh/cafaye"

    for remote in $remotes; do
        echo "ğŸ› ï¸  Syncing $remote..."
        ssh $SSH_OPT -o ConnectTimeout=5 "$remote" "caf sync pull" || echo "âŒ Failed: $remote"
    done
}

case "$command" in
    status) show_fleet_status ;;
    add) add_fleet_node "$@" ;;
    apply) fleet_apply ;;
    *) echo "Usage: caf fleet [status|add|apply]"; exit 1 ;;
esac
