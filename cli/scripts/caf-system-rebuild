#!/bin/bash
set -euo pipefail

# Rebuilds the Cafaye distributed development infrastructure using Home Manager
# Usage: caf-system-rebuild

echo "üöÄ Applying Cafaye Foundation Changes..."
export NIX_CONFIG="experimental-features = nix-command flakes"

CAFAYE_DIR="$HOME/.config/cafaye"
if [[ ! -d "$CAFAYE_DIR" ]]; then
    # Fallback to current directory for dev
    CAFAYE_DIR="$(pwd)"
fi

cd "$CAFAYE_DIR"

SYSTEM_ARCH=$(uname -m)
[[ "$SYSTEM_ARCH" == "arm64" ]] && SYSTEM_ARCH="aarch64"
SYSTEM_OS=$(uname -s | tr '[:upper:]' '[:lower:]')
[[ "$SYSTEM_OS" == "darwin" ]] && OS_SUFFIX="darwin" || OS_SUFFIX="linux"
FLAKE_CONFIG="${SYSTEM_ARCH}-${OS_SUFFIX}"

echo "üî® Switching to flake: .#${FLAKE_CONFIG}"
git add -A || true

attempt=1
max_attempts=2
while true; do
    if nix run --extra-experimental-features "nix-command flakes" nixpkgs#home-manager -- switch --flake ".#${FLAKE_CONFIG}" --show-trace; then
        break
    fi
    if [[ "$attempt" -ge "$max_attempts" ]]; then
        echo "‚ùå Rebuild failed after ${max_attempts} attempts."
        echo "Recovery options:"
        echo "  - Retry: caf apply"
        echo "  - Roll back: home-manager generations && home-manager switch --rollback"
        exit 1
    fi
    attempt=$((attempt + 1))
    echo "‚ö†Ô∏è  Rebuild failed, retrying (${attempt}/${max_attempts})..."
done

echo "‚úÖ Changes applied successfully!"
