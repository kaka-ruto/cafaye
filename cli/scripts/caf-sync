#!/bin/bash
set -euo pipefail

# Cafaye Sync: Sync state between nodes via Git
# Usage: caf-sync [push|pull]

CAFAYE_DIR="$HOME/.config/cafaye"
if [[ ! -d "$CAFAYE_DIR" ]]; then
    CAFAYE_DIR="$(pwd)"
fi

cd "$CAFAYE_DIR"

command="$1"

case "$command" in
    push)
        echo "üì§ Syncing changes to Git Source of Truth..."
        git add -A || true
        # Check if there are changes to commit
        if ! git diff-index --quiet HEAD --; then
            git commit -m "Sync: environment update from $(hostname)"
        fi
        current_branch="$(git rev-parse --abbrev-ref HEAD)"
        git push origin "$current_branch"
        echo "‚úÖ Changes pushed."
        ;;
    pull)
        echo "üì• Pulling updates from Git Source of Truth..."
        current_branch="$(git rev-parse --abbrev-ref HEAD)"
        if ! git pull --rebase origin "$current_branch"; then
            echo "‚ö†Ô∏è  Rebase conflict detected."
            echo "Run these steps to recover:"
            echo "  git status"
            echo "  git rebase --continue   # after resolving files"
            echo "  or git rebase --abort   # to cancel"
            exit 1
        fi
        echo "üî® Applying changes..."
        caf-system-rebuild
        echo "‚úÖ Sync complete."
        ;;
    *)
        echo "Usage: caf-sync [push|pull]"
        exit 1
        ;;
esac
