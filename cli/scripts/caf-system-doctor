#!/bin/bash

# Cafaye OS System Doctor
# Check system health and suggest fixes

echo "ü©∫ Cafaye OS System Doctor"
echo "=========================="
echo ""

ISSUES=0

# Check NixOS/Home Manager generation
echo -n "Checking Environment generation... "
if [ -L /nix/var/nix/profiles/system ]; then
  GEN=$(readlink /nix/var/nix/profiles/system | grep -oE 'system-[0-9]+' | cut -d- -f2)
  echo "‚úì NixOS Generation $GEN"
elif command -v home-manager &> /dev/null; then
  GEN=$(home-manager generations | head -n 1 | awk '{print $5}')
  echo "‚úì HM Generation $GEN"
else
  echo "‚ö† Unable to determine generation"
  ((ISSUES++))
fi

# Check Tailscale
echo -n "Checking Tailscale... "
if command -v tailscale &> /dev/null; then
  TS_STATUS=$(tailscale status --short 2>/dev/null || echo "Not connected")
  if [[ "$TS_STATUS" != "Not connected" ]]; then
    echo "‚úì $TS_STATUS"
  else
    echo "‚ö† Not connected"
    ((ISSUES++))
  fi
else
  echo "‚óã Not installed"
fi

# Check disk space
echo -n "Checking disk space... "
ROOT_USAGE=$(df / | awk 'NR==2 {print $5}' | tr -d '%')
if [ "$ROOT_USAGE" -lt 80 ]; then
  echo "‚úì ${ROOT_USAGE}% used"
elif [ "$ROOT_USAGE" -lt 90 ]; then
  echo "‚ö† ${ROOT_USAGE}% used (getting full)"
  ((ISSUES++))
else
  echo "‚ùå ${ROOT_USAGE}% used (critical!)"
  ((ISSUES++))
fi

# Check Nix store
echo -n "Checking Nix store... "
STORE_COUNT=$(ls /nix/store 2>/dev/null | wc -l)
if [ "$STORE_COUNT" -lt 50000 ]; then
  echo "‚úì $STORE_COUNT paths"
else
  echo "‚ö† $STORE_COUNT paths (consider running nix-collect-garbage)"
  ((ISSUES++))
fi

# Check failed systemd units
echo -n "Checking systemd units... "
FAILED_UNITS=$(systemctl --failed --no-pager --no-legend 2>/dev/null | wc -l)
if [ "$FAILED_UNITS" -eq 0 ]; then
  echo "‚úì No failed units"
else
  echo "‚ö† $FAILED_UNITS failed unit(s)"
  systemctl --failed --no-pager --no-legend 2>/dev/null | head -5
  ((ISSUES++))
fi

# Check PostgreSQL (if enabled)
echo -n "Checking PostgreSQL... "
if systemctl is-enabled --quiet postgresql 2>/dev/null; then
  if systemctl is-active --quiet postgresql; then
    echo "‚úì Running"
  else
    echo "‚ùå Enabled but not running"
    ((ISSUES++))
  fi
else
  echo "‚óã Not enabled"
fi

# Check Redis (if enabled)
echo -n "Checking Redis... "
if systemctl is-enabled --quiet redis-default 2>/dev/null; then
  if systemctl is-active --quiet redis-default; then
    echo "‚úì Running"
  else
    echo "‚ùå Enabled but not running"
    ((ISSUES++))
  fi
else
  echo "‚óã Not enabled"
fi

# Check Docker (if enabled)
echo -n "Checking Docker... "
if systemctl is-enabled --quiet docker 2>/dev/null; then
  if systemctl is-active --quiet docker; then
    echo "‚úì Running"
  else
    echo "‚ùå Enabled but not running"
    ((ISSUES++))
  fi
else
  echo "‚óã Not enabled"
fi

# Check MySQL (if enabled)
echo -n "Checking MySQL... "
if systemctl is-enabled --quiet mysql 2>/dev/null; then
  if systemctl is-active --quiet mysql; then
    echo "‚úì Running"
  else
    echo "‚ùå Enabled but not running"
    ((ISSUES++))
  fi
else
  echo "‚óã Not enabled"
fi

# Check Runtimes
echo -n "Checking Ruby... "
if command -v ruby &> /dev/null; then
  echo "‚úì $(ruby -v | awk '{print $2}')"
else
  echo "‚óã Not installed"
fi

echo -n "Checking Rails... "
if command -v rails &> /dev/null; then
  echo "‚úì $(rails -v | awk '{print $2}')"
else
  echo "‚óã Not installed"
fi

echo ""
echo "=========================="
if [ $ISSUES -eq 0 ]; then
  echo "‚úÖ All checks passed! System is healthy."
else
  echo "‚ö†Ô∏è  Found $ISSUES issue(s). Review above for details."
  echo ""
  echo "üí° Suggestions:"
  [ "$ROOT_USAGE" -ge 80 ] && echo "   - Run: sudo nix-collect-garbage -d"
  [ "$FAILED_UNITS" -gt 0 ] && echo "   - Run: systemctl status <unit> to investigate"
  [ "$STORE_COUNT" -ge 50000 ] && echo "   - Run: sudo nix-collect-garbage -d"
fi

# Always exit 0 - this is informational, not an error
exit 0
