#!/bin/bash

# Cafaye OS Config Refresh (inspired by omarchy-refresh-config)
# Copies the named config from /etc/cafaye/editors/defaults/X/Y -> ~/.config/X/Y.
# If the config already exists, a backup of the existing will be taken as .bak.TIMESTAMP.

config_file=$1

if [[ -z "$config_file" ]]; then
  cat <<USAGE
  Usage: $0 [config_path]

  Must provide a file path from the .config directory to be refreshed.
  To copy /etc/cafaye/editors/defaults/nvim/init.lua to ~/.config/nvim/init.lua

    $0 nvim/init.lua
USAGE
  exit 1
fi

# Backup the destination file (with timestamp) to avoid clobbering
user_config_file="${HOME}/.config/$config_file"
default_config_file="/etc/cafaye/editors/defaults/$config_file"
backup_config_file="$user_config_file.bak.$(date +%s)"

if [[ ! -f "$default_config_file" ]]; then
  echo "❌ Default config not found: $default_config_file"
  exit 1
fi

# Ensure parent directory exists
mkdir -p "$(dirname "$user_config_file")"

if [[ -f "$user_config_file" ]]; then
  # Create preliminary backup
  cp -f "$user_config_file" "$backup_config_file" 2>/dev/null

  # Replace config with new default
  cp -f "$default_config_file" "$user_config_file" 2>/dev/null

  # Compare and delete/inform accordingly
  if cmp -s "$user_config_file" "$backup_config_file"; then
    rm "$backup_config_file"
    echo "✅ Config unchanged (no backup needed)"
  else
    echo -e "\e[31mReplaced $user_config_file with Cafaye default.\nSaved backup as ${backup_config_file}.\n\n\e[32mChanges:\e[0m"
    diff "$user_config_file" "$backup_config_file" || true
  fi
else
  # Config file did not exist already
  cp -f "$default_config_file" "$user_config_file" 2>/dev/null
  echo "✅ Created $user_config_file from defaults"
fi
