#!/bin/bash

# Cafaye OS Log Uploader (inspired by omarchy-upload-log)
# Upload logs to 0x0.st

LOG_TYPE="${1:-this-boot}"
TEMP_LOG="/tmp/cafaye-upload-log.txt"
SYSTEM_INFO="/tmp/cafaye-system-info.txt"

# Get system information
{
  echo "========================================="
  echo "CAFAYE OS SYSTEM INFORMATION"
  echo "========================================="
  echo "Hostname: $(hostname)"
  echo "Cafaye Version: $(cat /etc/cafaye/version 2>/dev/null || echo 'unknown')"
  echo "NixOS Version: $(nixos-version 2>/dev/null || echo 'unknown')"
  echo "Kernel: $(uname -r)"
  echo "Date: $(date)"
  echo ""
  if command -v fastfetch >/dev/null 2>&1; then
    fastfetch --pipe 2>/dev/null || echo "Failed to get system info"
  fi
  echo ""
  echo "========================================="
  echo "LOG CONTENT"
  echo "========================================="
  echo ""
} >"$SYSTEM_INFO"

case "$LOG_TYPE" in
this-boot)
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  journalctl -b 0 --no-pager >>"$TEMP_LOG" 2>/dev/null

  if [ ! -s "$TEMP_LOG" ]; then
    echo "Error: No logs found for current boot"
    exit 1
  fi

  echo "Uploading current boot logs to 0x0.st..."
  ;;

last-boot)
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  journalctl -b -1 --no-pager >>"$TEMP_LOG" 2>/dev/null

  if [ ! -s "$TEMP_LOG" ]; then
    echo "Error: No logs found for previous boot"
    exit 1
  fi

  echo "Uploading previous boot logs to 0x0.st..."
  ;;

installed-packages)
  cat "$SYSTEM_INFO" >"$TEMP_LOG"
  {
    echo ""
    echo "========================================="
    echo "NIX SYSTEM PACKAGES"
    echo "========================================="
    nix-store -q --references /run/current-system/sw 2>/dev/null | head -200 || echo "Failed to get package list"
  } >>"$TEMP_LOG"

  if [ ! -s "$TEMP_LOG" ]; then
    echo "Error: Failed to gather system information"
    exit 1
  fi

  echo "Uploading system information to 0x0.st..."
  ;;

*)
  echo "Usage: $0 [this-boot|last-boot|installed-packages]"
  echo "  this-boot           - Upload logs from current boot"
  echo "  last-boot           - Upload logs from previous boot"
  echo "  installed-packages  - Upload system info and installed packages"
  exit 1
  ;;
esac

echo ""

URL=$(curl -sF "file=@$TEMP_LOG" -Fexpires=24 https://0x0.st)

if [ $? -eq 0 ] && [ -n "$URL" ]; then
  echo "âœ“ Log uploaded successfully!"
  echo "Share this URL:"
  echo ""
  echo "  $URL"
  echo ""
  echo "This link will expire in 24 hours."
else
  echo "Error: Failed to upload log file"
  exit 1
fi
