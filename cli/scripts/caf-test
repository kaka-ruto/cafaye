#!/usr/bin/env bash
# Cafaye OS Test Runner
# Self-bootstraps BATS (Bash Automated Testing System)

set -e
REPO_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
CACHE_DIR="$REPO_DIR/.cache"
BATS_DIR="$CACHE_DIR/bats-core"
BATS_BIN="$BATS_DIR/bin/bats"

# --- Bootstrap BATS ---
ensure_bats() {
    if [[ ! -f "$BATS_BIN" ]]; then
        echo "â¬‡ï¸  Installing BATS to $BATS_DIR..."
        mkdir -p "$CACHE_DIR"
        git clone --depth 1 https://github.com/bats-core/bats-core.git "$BATS_DIR" > /dev/null 2>&1
    fi
    export PATH="$CACHE_DIR/bats-core/bin:$PATH"
}

# --- Helper: Check Nix ---
check_nix() {
    if ! command -v nix &> /dev/null; then
        echo "âŒ Error: Nix is not installed."
        echo "   Layer 2+ tests require the Nix package manager."
        echo "   Please run the bootstrap script or install Nix manually:"
        echo "   curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install"
        exit 1
    fi
}

# --- Runners ---
run_unit() {
    ensure_bats
    echo "ðŸ”¬ Running Unit Tests (BATS)..."
    
    # Run all .bats files in tests/unit
    if ! "$BATS_BIN" -r tests/unit; then
        echo "âŒ Unit Tests Failed"
        exit 1
    fi
}

run_integration_tests() {
    echo ""
    echo "ðŸšœ Running Integration Tests (Requires Nix + KVM)..."
    if ! command -v nix &> /dev/null; then
        echo "Error: Nix not found. Skipping NixOS integration tests."
        return 1
    fi
    nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).core-unified" --print-build-logs
}

# --- Main ---
case "$1" in
    unit|all)
        run_unit
        ;;
    # Valid shortcuts for specific integration tests
    core)
        check_nix
        echo "ðŸšœ Running Core Integration Tests..."
        nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).core-unified" --print-build-logs
        ;;
    cli-integration)
        check_nix
        echo "ðŸšœ Running CLI Integration Tests..."
        nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).cli-unified" --print-build-logs
        ;;
    modules)
        check_nix
        echo "ðŸšœ Running Modules Integration Tests..."
        nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).modules-unified" --print-build-logs
        ;;
    integration)
        check_nix
        run_integration_tests
        ;;
    *)
        echo "Usage: caf-test [unit|integration|all]"
        exit 1
        ;;
esac
