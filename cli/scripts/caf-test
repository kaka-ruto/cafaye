#!/usr/bin/env bash
# Cafaye OS Test Runner
# Self-bootstraps BATS (Bash Automated Testing System)

set -e
REPO_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
CACHE_DIR="$REPO_DIR/.cache"
BATS_DIR="$CACHE_DIR/bats-core"
BATS_BIN="$BATS_DIR/bin/bats"

# --- Bootstrap BATS ---
ensure_bats() {
    if [[ ! -f "$BATS_BIN" ]]; then
        echo "â¬‡ï¸  Installing BATS to $BATS_DIR..."
        mkdir -p "$CACHE_DIR"
        git clone --depth 1 https://github.com/bats-core/bats-core.git "$BATS_DIR" > /dev/null 2>&1
    fi
    export PATH="$CACHE_DIR/bats-core/bin:$PATH"
}

# --- Helper: Check Nix ---
check_nix() {
    if ! command -v nix &> /dev/null; then
        echo "â¬‡ï¸  Installing Determinate Nix (Required dependency)..."
        curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
        
        # Source Nix immediately
        if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        fi
        echo "âœ… Nix installed. Resuming tests..."
    fi
}

# --- Runners ---
run_unit() {
    ensure_bats
    echo "ğŸ”¬ Running Unit Tests (BATS)..."
    
    local target="${1:-tests/unit}"
    
    # Run specific file or all .bats files in tests/unit
    if ! "$BATS_BIN" -r "$target"; then
        echo "âŒ Unit Tests Failed"
        exit 1
    fi
}

run_integration_target() {
    local target=$1
    check_nix
    echo "ğŸšœ Running Individual Integration Test: $target..."
    nix build ".#individualChecks.$(nix eval --raw --impure --expr builtins.currentSystem).$target" --print-build-logs
}

run_integration_tests() {
    check_nix
    echo "ğŸšœ Running Unified Integration Tests..."
    nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).core-unified" --print-build-logs
}

# --- Main ---
case "$1" in
    unit|all)
        run_unit "$2"
        ;;
    # Shortcuts for unified suites
    core)
        check_nix; echo "ğŸšœ Core Unified..."; nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).core-unified" --print-build-logs ;;
    cli-integration)
        check_nix; echo "ğŸšœ CLI Unified..."; nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).cli-unified" --print-build-logs ;;
    modules)
        check_nix; echo "ğŸšœ Modules Unified..."; nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).modules-unified" --print-build-logs ;;
    
    # Integration runner
    integration)
        if [[ -n "$2" ]]; then
            run_integration_target "$2"
        else
            run_integration_tests
        fi
        ;;
    *)
        echo "Usage: caf-test [unit <file> | integration <name> | core | modules | all]"
        exit 1
        ;;
esac
