#!/usr/bin/env bash
# Cafaye OS Unified Test Runner
# Inspired by Minitest/Rails

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

REPO_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
cd "$REPO_DIR"

usage() {
    echo -e "${BLUE}Cafaye OS Test Runner${NC}"
    echo "Usage: caf-test [section] [test_name]"
    echo ""
    echo "Sections:"
    echo "  installer         Run Layer 0 installer logic tests"
    echo "  all               Run all unified tests (Core, CLI, Modules)"
    echo "  core              Run unified core system tests"
    echo "  cli               Run unified CLI logic tests"
    echo "  modules           Run unified module/stack tests"
    echo "  integration       Run complex integration tests (Rails/Setup)"
    echo "  individual <name> Run a specific individual NixOS test"
    echo ""
    echo "Example:"
    echo "  caf-test core"
    echo "  caf-test individual core-boot"
}

# --- Section: Installer ---
run_installer_tests() {
    echo -e "${BLUE}▶ Running Installer Tests (Layer 0)...${NC}"
    
    # Ensure dependencies for testing are present
    if ! command -v jq &> /dev/null; then
       if command -v nix &> /dev/null; then
          echo "Installing jq via nix..."
          export PATH="$(nix build nixpkgs#jq --no-link --print-out-paths --extra-experimental-features "nix-command flakes")/bin:$PATH"
       fi
    fi

    bash installer/tests/run_tests.sh
}

# --- Section: NixOS Tests ---
run_nixos_test() {
    local target=$1
    echo -e "${BLUE}▶ Running NixOS Test: $target...${NC}"
    
    # Check if we are on a system with Nix
    if ! command -v nix &> /dev/null; then
        echo -e "${RED}Error: Nix not found. NixOS tests require Nix.${NC}"
        exit 1
    fi

    # Run the test via flake checks
    nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).$target" --print-build-logs
}

run_individual_nixos_test() {
    local name=$1
    echo -e "${BLUE}▶ Running Individual NixOS Test: $name...${NC}"
    nix build ".#individualChecks.$(nix eval --raw --impure --expr builtins.currentSystem).$name" --print-build-logs
}

# --- Main Logic ---
case "$1" in
    installer)
        run_installer_tests
        ;;
    all)
        run_installer_tests
        run_nixos_test "core-unified"
        run_nixos_test "cli-unified"
        run_nixos_test "modules-unified"
        ;;
    core)
        run_nixos_test "core-unified"
        ;;
    cli)
        run_nixos_test "cli-unified"
        ;;
    modules)
        run_nixos_test "modules-unified"
        ;;
    integration)
        run_nixos_test "integration-setup"
        run_nixos_test "integration-rails"
        ;;
    individual)
        if [[ -z "$2" ]]; then usage; exit 1; fi
        run_individual_nixos_test "$2"
        ;;
    "")
        usage
        ;;
    *)
        echo -e "${RED}Unknown section: $1${NC}"
        usage
        exit 1
        ;;
esac
