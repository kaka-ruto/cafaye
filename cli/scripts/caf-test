#!/usr/bin/env bash
# Cafaye OS Test Launcher
# Routes commands to the correct test suite

set -e

# Repository Root
REPO_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
cd "$REPO_DIR"

# Global Config
TIMEOUT_MINUTES=30
STATE_FILE_TEST="/tmp/cafaye-cli-test-state.json"
export STATE_FILE="$STATE_FILE_TEST"

usage() {
    echo "Cafaye OS Test Runner (caf-test)"
    echo "Usage: caf-test [section]"
    echo ""
    echo "Sections:"
    echo "  unit              Run ALL local/unit tests (Fast)"
    echo "  installer         Run Layer 0 (Installer) tests"
    echo "  cli               Run Layer 1 (CLI/State) tests"
    echo "  integration       Run full VM integration tests (Slow)"
    echo ""
}

run_unit_tests() {
    echo ""
    echo "ðŸ”¬ Running Unit Tests (Local execution - No VM)..."
    
    # 1. Installer Logic
    echo "â–¶ Layer 0: Installer Wizard"
    bash tests/unit/installer/test_wizard.sh

    # 2. CLI Logic
    echo "â–¶ Layer 1: CLI State Management"
    bash tests/unit/cli/test_state.sh
}

run_integration_tests() {
    echo ""
    echo "ðŸšœ Running Integration Tests (Requires Nix + KVM)..."
    if ! command -v nix &> /dev/null; then
        echo "Error: Nix not found. Skipping NixOS integration tests."
        return 1
    fi
    nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).core-unified" --print-build-logs
}

# --- Main Logic ---
case "$1" in
    unit|all)
        run_unit_tests
        ;;
    installer)
        bash tests/unit/installer/test_wizard.sh
        ;;
    cli)
        bash tests/unit/cli/test_state.sh
        ;;
    integration)
        run_integration_tests
        ;;
    *)
        usage
        exit 1
        ;;
esac
