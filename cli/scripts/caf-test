#!/usr/bin/env bash
# Cafaye OS Unified Test Runner
# Orchestrates Layer 0-3 testing
# Inspired by Minitest/Rails

set -e

# Repository Root
REPO_DIR=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
cd "$REPO_DIR"

# Global Config
TIMEOUT_MINUTES=30

usage() {
    echo "Cafaye OS Test Runner (caf-test)"
    echo "Usage: caf-test [section]"
    echo ""
    echo "Sections:"
    echo "  installer         Run Layer 0 (Bootstrap/Installer) tests"
    echo "  cli               Run Layer 1 (Orchestration/State) logic tests"
    echo "  core              Run Layer 2 (Security/Networking) NixOS tests"
    echo "  modules           Run Layer 3 (User Module) NixOS tests"
    echo "  all               Run ALL tests (Warning: Slow)"
    echo "  integration       Run Full Integration Tests"
    echo ""
}

run_installer_tests() {
    echo ""
    echo "▶ LAYER 0: INSTALLER / BOOTSTRAP ..."
    bash installer/tests/run_tests.sh
}

run_cli_tests() {
    echo ""
    echo "▶ LAYER 1: CLI / STATE LOGIC ..."
    bash cli/tests/run_tests.sh
}

run_nixos_test() {
    local target=$1
    echo ""
    echo "▶ NIXOS TEST: $target ..."
    if ! command -v nix &> /dev/null; then
        echo "Error: Nix not found. Skipping NixOS test."
        return 1
    fi
    nix build ".#checks.$(nix eval --raw --impure --expr builtins.currentSystem).$target" --print-build-logs
}

run_all_tests() {
    run_installer_tests
    run_cli_tests
    run_nixos_test "core-unified"
    run_nixos_test "modules-unified"
}

# --- Main Logic ---
case "$1" in
    installer)
        run_installer_tests
        ;;
    cli)
        run_cli_tests
        ;;
    core)
        run_nixos_test "core-unified"
        ;;
    modules)
        run_nixos_test "modules-unified"
        ;;
    all)
        run_all_tests
        ;;
    integration)
        run_nixos_test "integration-setup"
        ;;
    *)
        usage
        exit 1
        ;;
esac
