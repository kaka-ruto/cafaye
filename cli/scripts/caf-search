#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLI_MAIN="${SCRIPT_DIR}/../main.sh"

run_caf() {
  if [[ -f "$CLI_MAIN" ]]; then
    exec bash "$CLI_MAIN" "$@"
  fi
  exec caf "$@"
}

if command -v gum >/dev/null 2>&1 && [[ -t 0 ]] && [[ -t 1 ]]; then
  choice="$(printf '%s\n' \
    "quick install" \
    "install" \
    "status" \
    "project list" \
    "project switch" \
    "sync pull" \
    "sync push" \
    "fleet status" \
    "backup status" \
    "apply" | gum filter --placeholder "Search Cafaye commands...")"
else
  choice="${1:-status}"
fi

case "$choice" in
  "quick install")
    if command -v gum >/dev/null 2>&1 && [[ -t 0 ]] && [[ -t 1 ]]; then
      tool="$(printf '%s\n' ruby python nodejs go rust rails django nextjs postgresql redis docker | gum filter --placeholder "Quick install tool...")"
      [[ -n "$tool" ]] && run_caf install "$tool"
    fi
    run_caf install
    ;;
  install) run_caf install ;;
  status) run_caf status ;;
  "project list") run_caf project list ;;
  "project switch") run_caf project switch ;;
  "sync pull") run_caf sync pull ;;
  "sync push") run_caf sync push ;;
  "fleet status") run_caf fleet status ;;
  "backup status") run_caf backup status ;;
  apply) run_caf apply ;;
  *)
    if [[ -n "$choice" ]]; then
      run_caf "$choice"
    fi
    ;;
esac
