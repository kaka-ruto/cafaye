#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"

DEFAULT_WORKSPACE_YML="${HOME}/.config/cafaye/config/cafaye/tmux/workspace.yml"
USER_WORKSPACE_YML="${HOME}/.config/cafaye/config/user/tmux/workspace.yml"
DEFAULT_WORKSPACE="${HOME}/.config/cafaye/config/cafaye/tmux/workspace.sh"
USER_WORKSPACE="${HOME}/.config/cafaye/config/user/tmux/workspace.sh"

# Development fallback (repo-local paths) when ~/.config/cafaye is not yet synced.
if [[ ! -f "$DEFAULT_WORKSPACE_YML" ]]; then
  DEFAULT_WORKSPACE_YML="${REPO_ROOT}/config/cafaye/tmux/workspace.yml"
fi
if [[ ! -f "$USER_WORKSPACE_YML" ]]; then
  USER_WORKSPACE_YML="${REPO_ROOT}/config/user/tmux/workspace.yml"
fi
if [[ ! -f "$DEFAULT_WORKSPACE" ]]; then
  DEFAULT_WORKSPACE="${REPO_ROOT}/config/cafaye/tmux/workspace.sh"
fi
if [[ ! -f "$USER_WORKSPACE" ]]; then
  USER_WORKSPACE="${REPO_ROOT}/config/user/tmux/workspace.sh"
fi

parse_workspace_yaml() {
  local yml="$1"
  local parsed
  local line t name cmd

  if command -v yq >/dev/null 2>&1; then
    parsed="$(yq -r '
      .session // "cafaye",
      .start_window // "terminal",
      (.windows // [] | map("\(.name // "")|\(.command // "")") | .[])
    ' "$yml" 2>/dev/null)" || return 1

    CAF_WORKSPACE_SESSION="$(printf '%s\n' "$parsed" | sed -n '1p')"
    CAF_WORKSPACE_START_WINDOW="$(printf '%s\n' "$parsed" | sed -n '2p')"
    mapfile -t CAF_WORKSPACE_WINDOWS < <(printf '%s\n' "$parsed" | sed -n '3,$p')
    return 0
  fi

  # Minimal fallback parser for tmuxinator-lite YAML:
  # session, start_window, windows: [{name, command}]
  CAF_WORKSPACE_WINDOWS=()
  name=""
  cmd=""
  while IFS= read -r line; do
    t="${line#"${line%%[![:space:]]*}"}"
    case "$t" in
      session:*)
        CAF_WORKSPACE_SESSION="${t#session: }"
        CAF_WORKSPACE_SESSION="${CAF_WORKSPACE_SESSION%\"}"
        CAF_WORKSPACE_SESSION="${CAF_WORKSPACE_SESSION#\"}"
        ;;
      start_window:*)
        CAF_WORKSPACE_START_WINDOW="${t#start_window: }"
        CAF_WORKSPACE_START_WINDOW="${CAF_WORKSPACE_START_WINDOW%\"}"
        CAF_WORKSPACE_START_WINDOW="${CAF_WORKSPACE_START_WINDOW#\"}"
        ;;
      -\ name:*)
        if [[ -n "$name" ]]; then
          CAF_WORKSPACE_WINDOWS+=("$name|$cmd")
        fi
        name="${t#- name: }"
        name="${name%\"}"
        name="${name#\"}"
        cmd=""
        ;;
      command:*)
        cmd="${t#command: }"
        cmd="${cmd%\"}"
        cmd="${cmd#\"}"
        ;;
    esac
  done <"$yml"

  if [[ -n "$name" ]]; then
    CAF_WORKSPACE_WINDOWS+=("$name|$cmd")
  fi
  [[ ${#CAF_WORKSPACE_WINDOWS[@]} -gt 0 ]]
}

load_workspace_shell() {
  local file="$1"
  if [[ -f "$file" ]]; then
    # shellcheck disable=SC1090
    source "$file"
    return 0
  fi
  return 1
}

if [[ -f "$USER_WORKSPACE_YML" ]] && parse_workspace_yaml "$USER_WORKSPACE_YML"; then
  :
elif [[ -f "$DEFAULT_WORKSPACE_YML" ]] && parse_workspace_yaml "$DEFAULT_WORKSPACE_YML"; then
  :
else
  load_workspace_shell "$DEFAULT_WORKSPACE" || true
  load_workspace_shell "$USER_WORKSPACE" || true
fi

CAF_WORKSPACE_SESSION="${CAF_WORKSPACE_SESSION:-${CAFAYE_TMUX_SESSION:-cafaye}}"
CAF_WORKSPACE_START_WINDOW="${CAF_WORKSPACE_START_WINDOW:-terminal}"

if [[ -z "${CAF_WORKSPACE_WINDOWS+x}" ]] || [[ ${#CAF_WORKSPACE_WINDOWS[@]} -eq 0 ]]; then
  echo "CAF_WORKSPACE_WINDOWS is empty; refusing to create session." >&2
  exit 1
fi

# Auto-add a fleet window when two or more nodes are configured.
maybe_add_fleet_window() {
  local has_fleet=0
  local node_count=0
  local w
  for w in "${CAF_WORKSPACE_WINDOWS[@]}"; do
    [[ "${w%%|*}" == "fleet" ]] && has_fleet=1 && break
  done
  [[ "$has_fleet" -eq 1 ]] && return

  if command -v caf-fleet >/dev/null 2>&1; then
    node_count="$(caf-fleet status 2>/dev/null | awk '/^  - /{c++} END{print c+0}')"
    if [[ "${node_count:-0}" -ge 2 ]]; then
      CAF_WORKSPACE_WINDOWS+=("fleet|watch -n 5 caf-fleet status")
    fi
  fi
}
maybe_add_fleet_window

create_session() {
  local first=1
  local window_def name cmd

  for window_def in "${CAF_WORKSPACE_WINDOWS[@]}"; do
    name="${window_def%%|*}"
    cmd="${window_def#*|}"

    if [[ -z "$name" ]]; then
      echo "Invalid window definition: '$window_def' (missing window name)." >&2
      exit 1
    fi

    if [[ "$first" -eq 1 ]]; then
      tmux new-session -d -s "$CAF_WORKSPACE_SESSION" -n "$name"
      first=0
    else
      tmux new-window -t "${CAF_WORKSPACE_SESSION}:" -n "$name"
    fi

    if [[ "$cmd" != "$window_def" ]] && [[ -n "$cmd" ]]; then
      tmux send-keys -t "${CAF_WORKSPACE_SESSION}:${name}" "PATH=\"${SCRIPT_DIR}:\$PATH\"; $cmd" C-m
    fi
  done

  tmux select-window -t "${CAF_WORKSPACE_SESSION}:${CAF_WORKSPACE_START_WINDOW}" 2>/dev/null || true
}

if ! tmux has-session -t "$CAF_WORKSPACE_SESSION" 2>/dev/null; then
  create_session
fi
