#!/bin/bash
set -euo pipefail

# Cafaye OS Neovim Distribution Setup
# Sets up the selected distribution with Cafaye theming

NVIM_CONFIG="$HOME/.config/nvim"
BACKUP_DIR="$HOME/.config/nvim-backup-$(date +%Y%m%d%H%M%S)"
MARKER_FILE="$HOME/.config/nvim/.cafaye-distro"

# Get active distribution
get_active_distribution() {
    for dist in lazyvim astronvim nvchad lunarvim; do
        val=$(caf-state-read "editors.distributions.nvim.$dist" 2>/dev/null)
        if [[ "$val" == "true" ]]; then
            echo "$dist"
            return
        fi
    done
    echo "none"
}

distribution=$(get_active_distribution)
CAFAYE_REPO="${HOME}/.config/cafaye"

if [[ "$distribution" == "none" ]]; then
    echo "‚ùå No distribution selected. Run: caf-editor-distribution-set nvim <distribution>"
    exit 1
fi

echo "üîß Setting up $distribution..."

# Backup existing config
if [[ -d "$NVIM_CONFIG" ]]; then
    echo "üì¶ Backing up existing config to $BACKUP_DIR"
    mv "$NVIM_CONFIG" "$BACKUP_DIR"
fi

case "$distribution" in
    lazyvim)
        echo "üì• Cloning LazyVim starter..."
        git clone https://github.com/LazyVim/starter "$NVIM_CONFIG" --depth 1
        rm -rf "$NVIM_CONFIG/.git"
        
        # Copy Cafaye user-layer defaults when available
        if [[ -f "${CAFAYE_REPO}/config/user/nvim/lazyvim/plugins/user.lua" ]]; then
            cp "${CAFAYE_REPO}/config/user/nvim/lazyvim/plugins/user.lua" \
               "$NVIM_CONFIG/lua/plugins/user.lua"
        fi
        ;;
        
    astronvim)
        echo "üì• Cloning AstroNvim..."
        git clone --depth 1 https://github.com/AstroNvim/template "$NVIM_CONFIG"
        rm -rf "$NVIM_CONFIG/.git"
        
        if [[ -f "${CAFAYE_REPO}/config/user/nvim/astronvim/init.lua" ]]; then
            cp "${CAFAYE_REPO}/config/user/nvim/astronvim/init.lua" \
               "$NVIM_CONFIG/lua/user/init.lua" 2>/dev/null || true
        fi
        ;;
        
    nvchad)
        echo "üì• Cloning NvChad..."
        git clone https://github.com/NvChad/starter "$NVIM_CONFIG" --depth 1
        rm -rf "$NVIM_CONFIG/.git"
        
        if [[ -f "${CAFAYE_REPO}/config/user/nvim/nvchad/chadrc.lua" ]]; then
            cp "${CAFAYE_REPO}/config/user/nvim/nvchad/chadrc.lua" \
               "$NVIM_CONFIG/lua/chadrc.lua"
        fi
        ;;
        
    lunarvim)
        echo "üì• Installing LunarVim..."
        # LunarVim has its own installer
        LV_BRANCH='release-1.4/neovim-0.9' bash <(curl -s https://raw.githubusercontent.com/LunarVim/LunarVim/release-1.4/neovim-0.9/utils/installer/install.sh) -y
        
        if [[ -f "${CAFAYE_REPO}/config/user/nvim/lunarvim/config.lua" ]]; then
            cp "${CAFAYE_REPO}/config/user/nvim/lunarvim/config.lua" \
               "$HOME/.config/lvim/config.lua"
        fi
        ;;
esac

# Mark active distro for downstream tooling.
mkdir -p "$NVIM_CONFIG"
echo "$distribution" > "$MARKER_FILE"

echo "‚úÖ $distribution configured with Catppuccin theme!"
echo ""
echo "üí° Launch with: nvim"
echo "üìù User overrides: $NVIM_CONFIG/lua/plugins/"

caf-task-done "Nvim Distribution Setup"
