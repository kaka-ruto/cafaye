#!/usr/bin/env bash
set -euo pipefail

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "git-clean-branches must be run inside a git repository." >&2
  exit 1
fi

default_branch="$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || true)"
if [[ -z "$default_branch" ]]; then
  default_branch="main"
fi

current_branch="$(git branch --show-current)"

git fetch --prune

git branch --merged | sed 's/^[* ]*//' | while read -r branch; do
  [[ -z "$branch" ]] && continue
  [[ "$branch" == "$current_branch" ]] && continue
  [[ "$branch" == "$default_branch" ]] && continue
  git branch -d "$branch"
done
